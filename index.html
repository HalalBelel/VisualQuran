<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quran → Blisssymbol Translator</title>
  <style>
    /* Basic page styling */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif; background: #f0f4f8; color: #333;
      padding: 20px; line-height: 1.6;
    }
    .container {
      max-width: 960px; margin: 0 auto; background: #fff; padding: 20px;
      border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1, h2 { text-align: center; margin-bottom: 10px; color: #2c3e50; }
    p { text-align: center; margin-bottom: 20px; }
    form { display: flex; flex-wrap: wrap; gap: 10px; justify-content: space-around; margin-bottom: 20px; }
    form > div { flex: 1 1 200px; min-width: 200px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    select, input[type="number"] {
      width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
    }
    button {
      padding: 10px 20px; border: none; background: #3498db; color: #fff;
      font-size: 1rem; border-radius: 4px; cursor: pointer; transition: background 0.3s;
      margin: auto;
    }
    button:hover { background: #2980b9; }
    .output, .debug, .version {
      background: #f7f7f7; padding: 15px; border: 1px solid #ddd; border-radius: 4px;
      margin-bottom: 20px; overflow: auto;
    }
    .output {
      max-height: 300px; white-space: pre-wrap; font-family: "Courier New", Courier, monospace;
    }
    .debug { max-height: 300px; }
  </style>
</head>
<body>
<div class="container">
  <h1>Quran → Blisssymbol Translator</h1>
  <p>Select a Surah, verse, and optionally multiple consecutive verses.</p>
  
  <form id="promptForm">
    <div>
      <label for="surahSelect">Select Surah:</label>
      <select id="surahSelect"></select>
    </div>
    <div>
      <label for="verseSelect">Select Ayah:</label>
      <select id="verseSelect"></select>
    </div>
    <div>
      <label for="batchSelect">Consecutive Verses (max 111):</label>
      <input id="batchSelect" type="number" min="1" max="111" value="1" />
    </div>
    <div style="flex-basis: 100%; text-align: center;">
      <button type="submit">Translate to Bliss</button>
    </div>
  </form>
  
  <h2>Step 1. Raw Output (IDs from Translator)</h2>
  <div id="rawOutput" class="output"></div>
  
  <h2>Step 2. AI Review (Validating Codes)</h2>
  <div id="reviewedOutput" class="output"></div>
  
  <h2>Step 3. Final Output (Confirmed Blisssymbol IDs)</h2>
  <div id="verifiedOutput" class="output"></div>
  
  <h2>Debug Information</h2>
  <pre id="debugOutput" class="debug"></pre>
  
  <div id="versionInfo" class="version"></div>
  <pre id="updatesBox" class="version"></pre>
</div>

<script>
/***************************************************
  For each verse, we do:
  - Build the prompt
  - Call the AI endpoint
  - Log *all* data with no omission
****************************************************/

async function translateVerse(generationPayload, surah, verse) {
  // 1) Show entire payload in debug
  document.getElementById("debugOutput").innerText +=
    `\n--- GENERATION PAYLOAD (Surah ${surah}, Verse ${verse}) ---\n` +
    JSON.stringify(generationPayload, null, 2) + "\n\n";

  try {
    // 2) Fetch the endpoint
    const response = await fetch(config.VERCEL_PROXY_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(generationPayload)
    });

    // 3) Read raw text first
    const rawText = await response.text();

    // 4) Log raw text & status in debug
    document.getElementById("debugOutput").innerText +=
      `--- GENERATION RESPONSE (HTTP ${response.status}) ---\n` +
      rawText + "\n\n";

    // 5) Check HTTP status
    if (!response.ok) {
      // This means a non-2xx code (e.g. 404, 500)
      throw new Error(`HTTP Error ${response.status}. See debug output for details.`);
    }

    // 6) Attempt to parse as JSON
    let genData;
    try {
      genData = JSON.parse(rawText);
    } catch (parseErr) {
      // The raw text is not valid JSON (e.g. HTML error page)
      throw new Error("JSON parse error: " + parseErr.message);
    }

    // 7) If parsed OK, we can safely extract the content
    if (!genData.content) {
      throw new Error("No 'content' field in JSON response. Full object:\n" + JSON.stringify(genData, null, 2));
    }

    // 8) Return the text portion (or array) for further processing
    if (Array.isArray(genData.content)) {
      return genData.content[0].text;
    } else {
      return genData.content;
    }

  } catch (err) {
    // 9) Catch *all* errors
    document.getElementById("debugOutput").innerText +=
      `--- GENERATION ERROR (Surah ${surah}, Verse ${verse}) ---\n` +
      err.toString() + "\n\n";
    throw err; // re-throw so the caller knows
  }
}

/***************************************************
  Usage Example inside your form submission
****************************************************/
document.getElementById("promptForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  // (Pretend we have surah, verse, userPrompt, etc.)
  const surah = parseInt(document.getElementById("surahSelect").value);
  const verse = parseInt(document.getElementById("verseSelect").value);

  // Build the generation payload (example)
  const generationPayload = {
    model: config.MODEL_NAME,
    max_tokens: config.MAX_TOKENS_MULTIPLIER + config.MAX_TOKENS_OVERHEAD,
    system: config.USER_SYSTEM_ROLE,
    messages: [
      { role: "user", content: "Your user prompt here for Surah/Verse" }
    ]
  };

  // Call our new verbose function
  try {
    const rawBlissIDs = await translateVerse(generationPayload, surah, verse);
    // Now you have your rawBlissIDs, do the next steps...
    document.getElementById("rawOutput").innerText +=
      `Surah ${surah}, Verse ${verse}:\n${rawBlissIDs}\n\n`;
  } catch (err) {
    // Already logged error in debug, but you can also do something here.
    alert("Error generating Bliss ID codes. Check the Debug output for details.");
  }
});
</script>
</body>
</html>
